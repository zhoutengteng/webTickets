<link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
<script src="/static/bootstrap/js/bootstrap.bundle.js"
        integrity="sha384-/mhDoLbDldZc3qpsJHpLogda//BVZbgYuw6kof4u2FrCedxOtgRZDTHgHUhOCVim"
        crossorigin="anonymous"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

{# Django 进度条前端实时更新后端处理进度 – python后端实现进度条 https://blog.csdn.net/chaoren499/article/details/97135142#}
{# jQuery用FormData对象实现文件上传以及如何通过ajax下载文件  https://www.cnblogs.com/kaidarwang/p/9723938.html#}

<div class="container" style="width: 50%; margin: 0 25%">

     <form>
        <div class="input-group mb-3">
            <input type="file" class="form-control" name="uplfile" id="uplfile">
        </div>
         <button class="btn btn-primary" type="button"> 解析 </button>
    </form>

    <!--2. 进度条-->
    <div class="progress-div" style="visibility: hidden">
        <div class="progress">
            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="2" aria-valuemin="0"
                 aria-valuemax="100" style="min-width: 2em; width: 2%;">
                2%
            </div>
        </div>
    </div>
    </br>
    <div class="progress-text progress-bar-striped active" role="progressbar" aria-valuenow="2" aria-valuemin="0"
         aria-valuemax="100" style="min-width: 2em; width: 2%;">
    </div>
    <a href="#" class="progress-result link-danger link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"></a>
</div>

<script>
    $(function () {
        $('.btn').on('click', function () {
            console.log("come in ")
            {#var log = ""#}
            var sitv = setInterval(function () {
                var files = $("#uplfile").prop('files');
                var prog_url = '{% url 'tickets:progress_show'  %}'    + "?file=" + files[0].name          // prog_url指请求进度的url，后面会在django中设置
                $.getJSON(prog_url, function (num_progress) {
                    $('.progress-div').css('visibility', 'visible');
                    $('.progress-bar').css('width', num_progress + '%');
                    $('.progress-bar').text(num_progress + '%');
                    $('.progress-text').text("文件处理进度 " + num_progress + "%");
                    $('.progress-text').css('width', '100%');
                    if (num_progress >= '99') {
                        console.log("come in 99")
                        clearInterval(sitv);
                        $('.progress-bar').css('width', '100%');
                        $('.progress-bar').text('100%');
                    }
                });
            }, 100);                                 // 每10毫秒查询一次后台进度

            var files = $("#uplfile").prop('files');
            var data = new FormData();
            data.append('file', files[0]);  //参数名：file
            {#print(files[0])#}
            console.log("come in " + files[0])
            var thisurl = '{% url 'tickets:process_file' %}'   // 指当前页面的url
            $.ajax({
                url: thisurl,
                type: 'POST',
                data: data,
                cache: false, //禁止浏览器对该URL的缓存
                contentType: false,
                processData: false,
                success: function(res){
                    $('.progress-result').text(res['file']);
                    $('.progress-result').css('width', '100%');
                    $('.progress-result').attr("href", res['path']);
                    console.log("sitv over res " + res['file'])
                }
            });

            //$.post(thisurl, date=data, function (res) {
            //    // ...
            //    console.log("sitv over res " + res)
            //});

        })
    })
</script>